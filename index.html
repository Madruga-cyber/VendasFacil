<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas Fácil - Ponto de Vendas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- jsPDF e html2canvas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: 29, 78, 216; /* blue-700 */
            --color-secondary: 59, 130, 246; /* blue-500 */
            --color-accent: 34, 197, 94; /* green-500 */
            --font-family: 'Inter', sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: #f1f5f9; /* slate-100 */
        }
        .bg-primary { background-color: rgb(var(--color-primary)); }
        .bg-secondary { background-color: rgb(var(--color-secondary)); }
        .bg-accent { background-color: rgb(var(--color-accent)); }
        .text-primary { color: rgb(var(--color-primary)); }
        .text-secondary { color: rgb(var(--color-secondary)); }
        .border-primary { border-color: rgb(var(--color-primary)); }
        .hover\:bg-primary-dark:hover { background-color: rgb(var(--color-primary) / 0.9); }
        .ring-primary:focus { --tw-ring-color: rgb(var(--color-primary)); }
        .btn-primary {
            background-color: rgb(var(--color-primary));
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: rgb(var(--color-primary) / 0.8);
        }
        .btn-secondary {
            background-color: rgb(var(--color-secondary));
            color: white;
            transition: background-color 0.3s;
        }
       .btn-secondary:hover {
            background-color: rgb(var(--color-secondary) / 0.8);
        }
        .btn-accent {
            background-color: rgb(var(--color-accent));
            color: white;
            transition: background-color 0.3s;
        }
        .btn-accent:hover {
            background-color: rgb(var(--color-accent) / 0.8);
        }

        /* Animação para notificações (toast) */
        .toast-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .toast-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
        .toast-exit {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-exit-active {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 300ms, transform 300ms;
        }

        /* Estilo para a nota fiscal amarela */
        .nota-fiscal {
            font-family: 'Courier New', Courier, monospace;
            background-color: #ffffe0;
            border: 2px dashed #333;
            color: #333;
            padding: 20px;
            width: 302px; /* Largura comum de impressora térmica */
            margin: 0 auto;
        }
        .nota-fiscal * {
            font-size: 12px;
            line-height: 1.4;
        }
        .nota-fiscal .header {
            text-align: center;
            border-bottom: 1px dashed #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .nota-fiscal .item-row {
            display: flex;
            justify-content: space-between;
        }
        .nota-fiscal .totals {
            border-top: 1px dashed #333;
            padding-top: 10px;
            margin-top: 10px;
        }
        .nota-fiscal .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 10px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Animação para o ícone do carrinho */
        @keyframes jiggle {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.2) rotate(-5deg); }
        }
        .jiggle-animation {
            animation: jiggle 0.4s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Container da Aplicação -->
    <div id="app" class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-4 lg:p-6 min-h-screen">

        <!-- Coluna da Esquerda: Produtos e Categorias -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 flex flex-col">
            <header class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div id="logo-container" class="flex items-center gap-3">
                         <span id="header-cart-icon-container" class="bg-primary p-2 rounded-lg text-white">
                            <i data-lucide="shopping-cart"></i>
                        </span>
                        <h1 id="app-title" class="text-2xl font-bold text-gray-800">Vendas Fácil</h1>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openTab('vendas')" class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-blue-100 transition-colors"><i data-lucide="line-chart"></i></button>
                    <button onclick="openTab('estoque')" class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-blue-100 transition-colors"><i data-lucide="boxes"></i></button>
                    <button onclick="openSettingsModal()" class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-blue-100 transition-colors"><i data-lucide="settings"></i></button>
                </div>
            </header>

            <!-- Filtros de Categoria -->
            <div id="category-filters" class="flex flex-wrap gap-2 mb-4 pb-4 border-b">
                <!-- Categorias serão inseridas aqui -->
            </div>

            <!-- Lista de Produtos -->
            <div id="product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto flex-grow pr-2">
                <!-- Produtos serão inseridos aqui -->
            </div>
        </div>

        <!-- Coluna da Direita: Carrinho e Pagamento -->
        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pedido Atual</h2>
            
            <!-- Itens do Carrinho -->
            <div id="cart-items" class="flex-grow overflow-y-auto -mr-2 pr-2">
                <div id="cart-empty-message" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <i data-lucide="shopping-basket" class="w-16 h-16 mb-2"></i>
                    <span>Seu carrinho está vazio.</span>
                </div>
                <!-- Itens do carrinho serão inseridos aqui -->
            </div>

            <!-- Resumo e Total -->
            <div class="mt-auto pt-4 border-t">
                <div class="space-y-2 text-gray-700">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center">
                         <div class="flex items-center gap-1">
                            <span>Taxa</span>
                            <button onclick="editTax()" class="text-secondary hover:underline text-xs">(editar)</button>
                        </div>
                        <span id="cart-tax">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total</span>
                        <span id="cart-total">R$ 0,00</span>
                    </div>
                </div>
                <button id="checkout-button" onclick="openPaymentModal()" class="w-full btn-primary font-bold py-3 rounded-lg mt-4 flex items-center justify-center gap-2" disabled>
                    <span class="checkout-button-idle flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span>Finalizar Compra</span>
                    </span>
                    <span class="checkout-button-loading hidden items-center justify-center gap-2">
                        <i data-lucide="loader" class="animate-spin w-5 h-5"></i>
                        <span>Processando...</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Modal de Gerenciamento (Produtos/Categorias) -->
    <div id="management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 id="management-modal-title" class="text-2xl font-bold text-gray-800">Gerenciamento</h2>
                <button onclick="closeManagementModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Seção de Produtos -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Produtos</h3>
                        <button onclick="openProductModal()" class="btn-secondary text-sm px-4 py-2 rounded-lg flex items-center gap-1"><i data-lucide="plus" class="w-4 h-4"></i>Novo</button>
                    </div>
                    <div id="product-management-list" class="h-80 overflow-y-auto pr-2 space-y-2"></div>
                </div>
                <!-- Seção de Categorias -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Categorias</h3>
                        <button onclick="openCategoryModal()" class="btn-secondary text-sm px-4 py-2 rounded-lg flex items-center gap-1"><i data-lucide="plus" class="w-4 h-4"></i>Nova</button>
                    </div>
                    <div id="category-management-list" class="h-80 overflow-y-auto pr-2 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Tabs (Vendas/Estoque) -->
    <div id="tab-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl h-[90vh] p-8 flex flex-col transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 id="tab-modal-title" class="text-2xl font-bold text-gray-800">Painel</h2>
                <button onclick="closeTabModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div class="border-b border-gray-200">
                <nav id="tab-buttons" class="-mb-px flex space-x-8" aria-label="Tabs">
                    <!-- Tab buttons go here -->
                </nav>
            </div>
            <div id="tab-content" class="flex-grow overflow-y-auto mt-6">
                <!-- Tab content goes here -->
            </div>
        </div>
    </div>
    
    <!-- Modal Adicionar/Editar Produto -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition-all">
            <h2 id="product-modal-title" class="text-xl font-bold mb-4">Adicionar Produto</h2>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id">
                <div class="space-y-4">
                    <div>
                        <label for="product-category" class="block text-sm font-medium text-gray-700">Categoria</label>
                        <select id="product-category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required></select>
                    </div>
                     <div>
                        <label for="product-keywords" class="block text-sm font-medium text-gray-700">Palavras-chave (para IA)</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="product-keywords" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="Ex: doce, morango, refrescante">
                            <button type="button" onclick="generateProductNameAI()" class="p-2 btn-secondary rounded-md" title="Gerar nome e preço com IA">
                                <span class="gemini-button-idle">✨</span>
                                <span class="gemini-button-loading hidden animate-spin">⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                        <input type="text" id="product-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                           <label for="product-price" class="block text-sm font-medium text-gray-700">Preço (R$)</label>
                           <input type="number" id="product-price" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                        </div>
                        <div>
                           <label for="product-stock" class="block text-sm font-medium text-gray-700">Estoque</label>
                           <input type="number" id="product-stock" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                        </div>
                    </div>
                    <div>
                        <label for="product-image" class="block text-sm font-medium text-gray-700">URL da Imagem</label>
                        <input type="text" id="product-image" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="https://exemplo.com/imagem.png">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeProductModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Categoria -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition-all">
            <h2 id="category-modal-title" class="text-xl font-bold mb-4">Adicionar Categoria</h2>
            <form id="category-form" onsubmit="saveCategory(event)">
                <input type="hidden" id="category-id">
                <div>
                    <label for="category-name" class="block text-sm font-medium text-gray-700">Nome da Categoria</label>
                    <input type="text" id="category-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeCategoryModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Configurações -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition-all">
            <h2 class="text-xl font-bold mb-4">Configurações</h2>
            <div class="space-y-6">
                <div>
                    <label for="settings-app-name" class="block text-sm font-medium text-gray-700">Nome da Loja</label>
                    <input type="text" id="settings-app-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="settings-logo-url" class="block text-sm font-medium text-gray-700">URL do Logo</label>
                    <input type="text" id="settings-logo-url" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="https://exemplo.com/logo.png">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cor do Tema</label>
                    <div class="mt-2 flex gap-3">
                        <button onclick="changeTheme('blue')" class="w-8 h-8 rounded-full bg-blue-600 ring-2 ring-offset-2 ring-transparent focus:ring-blue-500"></button>
                        <button onclick="changeTheme('green')" class="w-8 h-8 rounded-full bg-green-600 ring-2 ring-offset-2 ring-transparent focus:ring-green-500"></button>
                        <button onclick="changeTheme('purple')" class="w-8 h-8 rounded-full bg-purple-600 ring-2 ring-offset-2 ring-transparent focus:ring-purple-500"></button>
                        <button onclick="changeTheme('red')" class="w-8 h-8 rounded-full bg-red-600 ring-2 ring-offset-2 ring-transparent focus:ring-red-500"></button>
                    </div>
                </div>
                <div>
                    <button onclick="openManagementModal()" class="w-full text-left px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 flex justify-between items-center">
                        <span>Gerenciar Produtos e Categorias</span>
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" onclick="saveSettings()" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 transform transition-all overflow-y-auto max-h-full">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Pagamento</h2>
                <button onclick="closePaymentModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div class="text-center my-4">
                <p class="text-gray-600">Total a Pagar</p>
                <p id="payment-total" class="text-4xl font-bold text-primary">R$ 0,00</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Pagamento com Dinheiro -->
                <div id="cash-payment" class="border rounded-lg p-4 text-center cursor-pointer hover:border-primary hover:bg-blue-50 transition" onclick="selectPaymentMethod('cash')">
                    <i data-lucide="banknote" class="w-12 h-12 mx-auto text-green-500"></i>
                    <p class="font-semibold mt-2">Dinheiro</p>
                </div>
                <!-- Pagamento com Cartão -->
                <div id="card-payment" class="border rounded-lg p-4 text-center cursor-pointer hover:border-primary hover:bg-blue-50 transition" onclick="selectPaymentMethod('card')">
                    <i data-lucide="credit-card" class="w-12 h-12 mx-auto text-indigo-500"></i>
                    <p class="font-semibold mt-2">Cartão</p>
                </div>
                <!-- Pagamento com QR Code (Pix) -->
                <div id="qrcode-payment" class="border rounded-lg p-4 text-center cursor-pointer hover:border-primary hover:bg-blue-50 transition" onclick="selectPaymentMethod('qrcode')">
                    <i data-lucide="qr-code" class="w-12 h-12 mx-auto text-blue-500"></i>
                    <p class="font-semibold mt-2">QR Code</p>
                </div>
            </div>

            <!-- Detalhes do Pagamento (Dinâmico) -->
            <div id="payment-details-container" class="mt-4">
                <!-- Detalhes Dinheiro -->
                <div id="cash-details" class="space-y-2 hidden">
                     <div>
                        <label for="cash-received" class="block text-sm font-medium text-gray-700">Valor Recebido</label>
                        <input type="number" id="cash-received" oninput="calculateChange()" class="mt-1 text-center w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    </div>
                    <div class="text-lg text-center">
                        <span>Troco: </span>
                        <span id="cash-change" class="font-bold">R$ 0,00</span>
                    </div>
                </div>
                <!-- Detalhes Cartão -->
                <div id="card-details" class="space-y-3 hidden">
                    <div>
                        <label for="card-name" class="block text-sm font-medium text-gray-700">Nome no Cartão</label>
                        <input type="text" id="card-name" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="NOME COMPLETO">
                    </div>
                    <div>
                        <label for="card-number" class="block text-sm font-medium text-gray-700">Número do Cartão</label>
                        <input type="text" id="card-number" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="0000 0000 0000 0000">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="card-expiry" class="block text-sm font-medium text-gray-700">Validade</label>
                            <input type="text" id="card-expiry" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="MM/AA">
                        </div>
                        <div>
                            <label for="card-cvv" class="block text-sm font-medium text-gray-700">CVV</label>
                            <input type="text" id="card-cvv" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="123">
                        </div>
                    </div>
                </div>
                 <!-- Detalhes QR Code -->
                <div id="qrcode-details" class="text-center hidden">
                    <img src="https://placehold.co/150x150/png?text=PIX+QR+Code" alt="[Imagem de um QR Code para pagamento via PIX]" class="mx-auto">
                </div>
            </div>

            <div class="mt-6">
                <button onclick="confirmPayment()" class="w-full btn-accent font-bold py-3 rounded-lg flex items-center justify-center gap-2">
                    <i data-lucide="party-popper"></i>
                    <span>Confirmar Pagamento</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Recibo -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all">
             <div id="receipt-content-wrapper">
                <!-- Conteúdo do recibo será inserido aqui no formato de nota fiscal -->
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
                 <button onclick="printReceipt()" class="w-full px-4 py-2 btn-secondary rounded-lg flex items-center justify-center gap-2"><i data-lucide="printer"></i>Imprimir</button>
                 <button onclick="generatePDF()" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2"><i data-lucide="file-down"></i>Gerar PDF</button>
            </div>
            <div class="mt-4 text-center">
                 <button onclick="closeReceiptModalAndReset()" class="px-4 py-2 btn-primary rounded-lg">Nova Venda</button>
            </div>
        </div>
    </div>

    <!-- Modal de Análise de IA (NOVO) -->
    <div id="ai-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6 transform transition-all flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">✨ Análise de Vendas com IA</h2>
                <button onclick="closeAiAnalysisModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div id="ai-analysis-content" class="prose max-w-none text-gray-700 overflow-y-auto" style="max-height: 60vh;">
                <!-- Conteúdo da análise será inserido aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[80] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center transform transition-all">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Ação</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" id="confirmation-modal-message">Tem certeza?</p>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="confirm-cancel-btn" type="button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-action-btn" type="button" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Notificação (Toast) -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all toast-enter">
        <span id="toast-message"></span>
    </div>

    <script>
        // --- ESTADO DA APLICAÇÃO ---
        let state = {
            products: [
                { id: 1, name: 'Café Expresso', categoryId: 1, price: 5.00, stock: 100, image: 'https://placehold.co/150x150/664229/FFFFFF?text=Café' },
                { id: 2, name: 'Cappuccino', categoryId: 1, price: 7.50, stock: 80, image: 'https://placehold.co/150x150/7d5a48/FFFFFF?text=Cappuccino' },
                { id: 3, name: 'Pão de Queijo', categoryId: 2, price: 4.00, stock: 50, image: 'https://placehold.co/150x150/f0e040/333333?text=Pão+de+Queijo' },
                { id: 4, name: 'Croissant', categoryId: 2, price: 6.00, stock: 40, image: 'https://placehold.co/150x150/d4a276/FFFFFF?text=Croissant' },
                { id: 5, name: 'Suco de Laranja', categoryId: 3, price: 8.00, stock: 60, image: 'https://placehold.co/150x150/ffa500/FFFFFF?text=Suco' },
                { id: 6, name: 'Água Mineral', categoryId: 3, price: 3.00, stock: 200, image: 'https://placehold.co/150x150/add8e6/000000?text=Água' }
            ],
            categories: [
                { id: 1, name: 'Cafés' },
                { id: 2, name: 'Salgados' },
                { id: 3, name: 'Bebidas' }
            ],
            cart: [], // { productId, name, price, quantity }
            salesHistory: [], // { id, items, subtotal, tax, total, paymentMethod, date, amountReceived, changeGiven, cardLast4 }
            settings: {
                appName: 'Vendas Fácil',
                logoUrl: '',
                taxRate: 0, // em porcentagem
                theme: 'blue',
            },
            activeCategoryFilter: 'all',
            currentPaymentMethod: null,
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO ---

        function renderAll() {
            renderCategories();
            renderProducts();
            renderCart();
            renderManagementLists();
            applySettings();
            updateCheckoutButton();
            lucide.createIcons();
        }

        function renderProducts() {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            const filteredProducts = state.products.filter(p => 
                state.activeCategoryFilter === 'all' || p.categoryId == state.activeCategoryFilter
            );

            if (filteredProducts.length === 0) {
                 productList.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">
                    <i data-lucide="coffee" class="w-12 h-12 mx-auto mb-2"></i>
                    <p>Nenhum produto encontrado nesta categoria.</p>
                </div>`;
                 lucide.createIcons();
                 return;
            }

            filteredProducts.forEach(product => {
                const isOutOfStock = product.stock <= 0;
                const productCard = document.createElement('div');
                productCard.className = `border rounded-lg p-3 flex flex-col text-center cursor-pointer transition-shadow hover:shadow-md relative ${isOutOfStock ? 'opacity-50 cursor-not-allowed' : ''}`;
                
                let imageHTML = `<img src="${product.image || 'https://placehold.co/150x150/cccccc/969696?text=Sem+Imagem'}" alt="[Imagem de ${product.name}]" class="w-full h-24 object-cover rounded-md mb-2" onerror="this.onerror=null;this.src='https://placehold.co/150x150/cccccc/969696?text=Sem+Imagem';">`;

                productCard.innerHTML = `
                    ${isOutOfStock ? '<div class="absolute inset-0 bg-white bg-opacity-50 flex items-center justify-center font-bold text-red-500">ESGOTADO</div>' : ''}
                    ${imageHTML}
                    <h3 class="font-semibold text-sm flex-grow">${product.name}</h3>
                    <p class="font-bold text-primary mt-1">${formatCurrency(product.price)}</p>
                `;
                
                productCard.onclick = () => !isOutOfStock && addToCart(product.id);
                
                productList.appendChild(productCard);
            });
        }

        function renderCategories() {
            const categoryFilters = document.getElementById('category-filters');
            categoryFilters.innerHTML = `
                <button onclick="filterByCategory('all')" class="category-btn ${state.activeCategoryFilter === 'all' ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'} px-4 py-1 rounded-full text-sm font-medium">Todos</button>
            `;
            state.categories.forEach(category => {
                const categoryBtn = document.createElement('button');
                categoryBtn.textContent = category.name;
                categoryBtn.onclick = () => filterByCategory(category.id);
                categoryBtn.className = `category-btn ${state.activeCategoryFilter == category.id ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'} px-4 py-1 rounded-full text-sm font-medium`;
                categoryFilters.appendChild(categoryBtn);
            });
        }
        
        function renderCart() {
            const cartItems = document.getElementById('cart-items');
            cartItems.innerHTML = ''; // Limpa o conteúdo atual
            
            if (state.cart.length === 0) {
                // Se o carrinho estiver vazio, insere a mensagem de carrinho vazio
                cartItems.innerHTML = `
                    <div id="cart-empty-message" class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i data-lucide="shopping-basket" class="w-16 h-16 mb-2"></i>
                        <span>Seu carrinho está vazio.</span>
                    </div>
                `;
                lucide.createIcons(); // Recria o ícone
            } else {
                // Se houver itens, renderiza cada um
                state.cart.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between py-2';
                    itemDiv.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="updateCartQuantity(${item.productId}, -1)" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateCartQuantity(${item.productId}, 1)" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300">+</button>
                        </div>
                        <span class="font-bold w-20 text-right">${formatCurrency(item.price * item.quantity)}</span>
                    `;
                    cartItems.appendChild(itemDiv);
                });
            }
            calculateTotals();
        }

        function renderManagementLists() {
            const productManagementList = document.getElementById('product-management-list');
            productManagementList.innerHTML = '';
            state.products.forEach(p => {
                productManagementList.innerHTML += `
                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100">
                        <div>
                            <p class="font-medium">${p.name}</p>
                            <p class="text-sm text-gray-500">${formatCurrency(p.price)} - Estoque: ${p.stock}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openProductModal(${p.id})" class="p-2 text-gray-500 hover:text-blue-600"><i data-lucide="edit"></i></button>
                            <button onclick="deleteProduct(${p.id})" class="p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2"></i></button>
                        </div>
                    </div>
                `;
            });

            const categoryManagementList = document.getElementById('category-management-list');
            categoryManagementList.innerHTML = '';
            state.categories.forEach(c => {
                 categoryManagementList.innerHTML += `
                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100">
                        <p class="font-medium">${c.name}</p>
                        <div class="flex gap-2">
                            <button onclick="openCategoryModal(${c.id})" class="p-2 text-gray-500 hover:text-blue-600"><i data-lucide="edit"></i></button>
                            <button onclick="deleteCategory(${c.id})" class="p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2"></i></button>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // --- FUNÇÕES DE LÓGICA ---
        function addToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) return;

            const cartItem = state.cart.find(item => item.productId === productId);
            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    showToast('Estoque máximo do produto atingido no carrinho.');
                    return;
                }
            } else {
                state.cart.push({ productId: product.id, name: product.name, price: product.price, quantity: 1 });
            }
            renderCart();
            updateCheckoutButton();
            
            // Feedback visual
            showToast(`${product.name} adicionado ao carrinho!`);
            const cartIcon = document.getElementById('header-cart-icon-container');
            if(cartIcon) {
                cartIcon.classList.remove('jiggle-animation');
                void cartIcon.offsetWidth;
                cartIcon.classList.add('jiggle-animation');
                setTimeout(() => cartIcon.classList.remove('jiggle-animation'), 400);
            }
        }

        function updateCartQuantity(productId, change) {
            const cartItem = state.cart.find(item => item.productId === productId);
            const product = state.products.find(p => p.id === productId);

            if (!cartItem) return;

            const newQuantity = cartItem.quantity + change;
            
            if (newQuantity > product.stock) {
                showToast('Quantidade excede o estoque disponível.');
                return;
            }

            if (newQuantity <= 0) {
                state.cart = state.cart.filter(item => item.productId !== productId);
            } else {
                cartItem.quantity = newQuantity;
            }
            renderCart();
            updateCheckoutButton();
        }

        function calculateTotals() {
            const subtotal = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const tax = subtotal * (state.settings.taxRate / 100);
            const total = subtotal + tax;

            document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('cart-tax').textContent = formatCurrency(tax);
            document.getElementById('cart-total').textContent = formatCurrency(total);
        }
        
        function updateCheckoutButton() {
            const checkoutButton = document.getElementById('checkout-button');
            checkoutButton.disabled = state.cart.length === 0;
            if (checkoutButton.disabled) {
                checkoutButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                checkoutButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function filterByCategory(categoryId) {
            state.activeCategoryFilter = categoryId;
            renderCategories();
            renderProducts();
        }

        function saveProduct(event) {
            event.preventDefault();
            const id = document.getElementById('product-id').value;
            const product = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('product-name').value,
                categoryId: parseInt(document.getElementById('product-category').value),
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                image: document.getElementById('product-image').value,
            };

            if (id) {
                const index = state.products.findIndex(p => p.id == id);
                state.products[index] = product;
                 showToast('Produto atualizado com sucesso!');
            } else {
                state.products.push(product);
                 showToast('Produto adicionado com sucesso!');
            }
            closeProductModal();
            renderAll();
        }

        function deleteProduct(id) {
            showConfirmationModal('Tem certeza que deseja remover este produto?', () => {
                state.products = state.products.filter(p => p.id !== id);
                state.cart = state.cart.filter(item => item.productId !== id);
                showToast('Produto removido com sucesso!');
                renderAll();
            });
        }
        
        function saveCategory(event) {
            event.preventDefault();
            const id = document.getElementById('category-id').value;
            const category = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('category-name').value,
            };
             if (id) {
                const index = state.categories.findIndex(c => c.id == id);
                state.categories[index] = category;
                showToast('Categoria atualizada com sucesso!');
            } else {
                state.categories.push(category);
                showToast('Categoria adicionada com sucesso!');
            }
            closeCategoryModal();
            renderAll();
        }

        function deleteCategory(id) {
            if (state.products.some(p => p.categoryId === id)) {
                showToast('Não é possível remover: existem produtos associados a esta categoria.');
                return;
            }
            showConfirmationModal('Tem certeza que deseja remover esta categoria?', () => {
                state.categories = state.categories.filter(c => c.id !== id);
                showToast('Categoria removida com sucesso!');
                renderAll();
            });
        }

        function applySettings() {
            document.getElementById('app-title').textContent = state.settings.appName;
            const logoContainer = document.getElementById('logo-container');
            if (state.settings.logoUrl) {
                logoContainer.innerHTML = `<img src="${state.settings.logoUrl}" alt="Logo" class="h-10"> <h1 id="app-title" class="text-2xl font-bold text-gray-800">${state.settings.appName}</h1>`;
            } else {
                logoContainer.innerHTML = `<span id="header-cart-icon-container" class="bg-primary p-2 rounded-lg text-white"><i data-lucide="shopping-cart"></i></span><h1 id="app-title" class="text-2xl font-bold text-gray-800">${state.settings.appName}</h1>`;
                lucide.createIcons();
            }
        }
        
        function saveSettings() {
            state.settings.appName = document.getElementById('settings-app-name').value;
            state.settings.logoUrl = document.getElementById('settings-logo-url').value;
            closeSettingsModal();
            applySettings();
            showToast('Configurações salvas!');
        }

        function changeTheme(theme) {
            state.settings.theme = theme;
            const root = document.documentElement;
            const themes = {
                blue: { primary: '29, 78, 216', secondary: '59, 130, 246' },
                green: { primary: '21, 128, 61', secondary: '34, 197, 94' },
                purple: { primary: '126, 34, 206', secondary: '168, 85, 247' },
                red: { primary: '220, 38, 38', secondary: '248, 113, 113' },
            };
            root.style.setProperty('--color-primary', themes[theme].primary);
            root.style.setProperty('--color-secondary', themes[theme].secondary);
            showToast(`Tema alterado para ${theme}!`);
        }

        function editTax() {
            const newTaxRate = prompt('Digite a nova taxa em porcentagem (%):', state.settings.taxRate);
            if (newTaxRate !== null && !isNaN(newTaxRate)) {
                state.settings.taxRate = parseFloat(newTaxRate);
                calculateTotals();
                showToast('Taxa atualizada!');
            }
        }
        
        function selectPaymentMethod(method) {
            state.currentPaymentMethod = method;
            const cashDiv = document.getElementById('cash-payment');
            const qrcodeDiv = document.getElementById('qrcode-payment');
            const cardDiv = document.getElementById('card-payment');
            const cashDetails = document.getElementById('cash-details');
            const qrcodeDetails = document.getElementById('qrcode-details');
            const cardDetails = document.getElementById('card-details');

            // Reset all first
            cashDiv.classList.remove('border-primary', 'bg-blue-50');
            qrcodeDiv.classList.remove('border-primary', 'bg-blue-50');
            cardDiv.classList.remove('border-primary', 'bg-blue-50');
            cashDetails.style.display = 'none';
            qrcodeDetails.style.display = 'none';
            cardDetails.style.display = 'none';


            if (method === 'cash') {
                cashDiv.classList.add('border-primary', 'bg-blue-50');
                cashDetails.style.display = 'block';
                document.getElementById('cash-received').focus();
            } else if (method === 'qrcode') {
                qrcodeDiv.classList.add('border-primary', 'bg-blue-50');
                qrcodeDetails.style.display = 'block';
            } else if (method === 'card') {
                cardDiv.classList.add('border-primary', 'bg-blue-50');
                cardDetails.style.display = 'block';
            }
        }
        
        function calculateChange() {
            const total = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0) * (1 + state.settings.taxRate / 100);
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = received - total;
            document.getElementById('cash-change').textContent = formatCurrency(Math.max(0, change));
        }

        function confirmPayment() {
            if (!state.currentPaymentMethod) {
                showToast('Por favor, selecione um método de pagamento.');
                return;
            }

            const subtotal = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const tax = subtotal * (state.settings.taxRate / 100);
            const total = subtotal + tax;

            const sale = {
                id: Date.now(),
                items: JSON.parse(JSON.stringify(state.cart)),
                subtotal,
                tax,
                total,
                paymentMethod: state.currentPaymentMethod,
                date: new Date().toISOString(),
            };
            
            if (sale.paymentMethod === 'cash') {
                const amountReceived = parseFloat(document.getElementById('cash-received').value) || 0;
                if (amountReceived < total) {
                    showToast('O valor recebido é menor que o total.');
                    return;
                }
                sale.amountReceived = amountReceived;
                sale.changeGiven = amountReceived - total;
            } else if (sale.paymentMethod === 'card') {
                const cardName = document.getElementById('card-name').value;
                const cardNumber = document.getElementById('card-number').value;
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCvv = document.getElementById('card-cvv').value;

                if (!cardName || !cardNumber || !cardExpiry || !cardCvv) {
                    showToast('Por favor, preencha todos os dados do cartão.');
                    return;
                }
                sale.cardLast4 = cardNumber.slice(-4);
            }

             // Atualizar estoque
            state.cart.forEach(cartItem => {
                const product = state.products.find(p => p.id === cartItem.productId);
                if (product) {
                    product.stock -= cartItem.quantity;
                }
            });

            state.salesHistory.push(sale);
            
            closePaymentModal();
            showReceipt(sale);
            showToast('Venda finalizada com sucesso!');
        }
        
        function showReceipt(sale) {
            const receiptContent = document.getElementById('receipt-content-wrapper');
            let itemsHtml = '';
            sale.items.forEach(item => {
                itemsHtml += `
                    <div class="item-row">
                        <span>${item.quantity}x ${item.name}</span>
                        <span>${formatCurrency(item.price * item.quantity)}</span>
                    </div>
                `;
            });

            let paymentDetailsHtml = '';
            if (sale.paymentMethod === 'cash' && typeof sale.changeGiven !== 'undefined') {
                paymentDetailsHtml = `
                    <div class="item-row"><span>Valor Recebido:</span> <span>${formatCurrency(sale.amountReceived)}</span></div>
                    <div class="item-row"><span>Troco:</span> <span>${formatCurrency(sale.changeGiven)}</span></div>
                `;
            } else if (sale.paymentMethod === 'card' && sale.cardLast4) {
                 paymentDetailsHtml = `<div class="item-row"><span>Cartão Final:</span> <span>**** ${sale.cardLast4}</span></div>`;
            }

            receiptContent.innerHTML = `
                <div class="nota-fiscal" id="receipt-to-print">
                    <div class="header">
                        <h3 class="font-bold text-lg">${state.settings.appName}</h3>
                        <p>COMPROVANTE DE VENDA</p>
                        <p>${new Date(sale.date).toLocaleString('pt-BR')}</p>
                    </div>
                    <div class="items">
                        ${itemsHtml}
                    </div>
                    <div class="totals">
                        <div class="item-row"><span>Subtotal:</span> <span>${formatCurrency(sale.subtotal)}</span></div>
                        <div class="item-row"><span>Taxa:</span> <span>${formatCurrency(sale.tax)}</span></div>
                        <div class="item-row font-bold"><span>Total:</span> <span>${formatCurrency(sale.total)}</span></div>
                        ${paymentDetailsHtml}
                    </div>
                    <div class="footer">
                        Obrigado pela preferência!
                    </div>
                </div>
            `;
            document.getElementById('receipt-modal').classList.remove('hidden');
        }

        function printReceipt() {
            const printContent = document.getElementById('receipt-to-print').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Recibo</title>');
            printWindow.document.write(`<style>
                body { font-family: 'Courier New', Courier, monospace; font-size: 12px; }
                .item-row { display: flex; justify-content: space-between; }
                .header, .footer { text-align: center; }
                .totals { border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px; }
            </style>`);
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const receiptElement = document.getElementById('receipt-to-print');
            const canvas = await html2canvas(receiptElement, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`recibo-${Date.now()}.pdf`);
        }

        function closeReceiptModalAndReset() {
            document.getElementById('receipt-modal').classList.add('hidden');
            // Resetar o estado para uma nova venda
            state.cart = [];
            state.currentPaymentMethod = null;
            renderAll();
        }


        // --- FUNÇÕES DE NAVEGAÇÃO E MODAIS ---

        function openProductModal(id = null) {
            const form = document.getElementById('product-form');
            form.reset();
            document.getElementById('product-id').value = '';
            
            const categorySelect = document.getElementById('product-category');
            categorySelect.innerHTML = '';
            state.categories.forEach(c => {
                categorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            if (id) {
                document.getElementById('product-modal-title').textContent = 'Editar Produto';
                const product = state.products.find(p => p.id === id);
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-category').value = product.categoryId;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-image').value = product.image;
            } else {
                document.getElementById('product-modal-title').textContent = 'Adicionar Produto';
            }
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        function openCategoryModal(id = null) {
            const form = document.getElementById('category-form');
            form.reset();
            document.getElementById('category-id').value = '';

            if (id) {
                document.getElementById('category-modal-title').textContent = 'Editar Categoria';
                const category = state.categories.find(c => c.id === id);
                document.getElementById('category-id').value = category.id;
                document.getElementById('category-name').value = category.name;
            } else {
                document.getElementById('category-modal-title').textContent = 'Adicionar Categoria';
            }
            document.getElementById('category-modal').classList.remove('hidden');
        }
        
        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
        }
        
        function openSettingsModal() {
            document.getElementById('settings-app-name').value = state.settings.appName;
            document.getElementById('settings-logo-url').value = state.settings.logoUrl;
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function openManagementModal() {
            closeSettingsModal(); // Fecha as configurações se estiverem abertas
            document.getElementById('management-modal').classList.remove('hidden');
            renderManagementLists();
        }

        function closeManagementModal() {
            document.getElementById('management-modal').classList.add('hidden');
        }
        
        function openPaymentModal() {
            const checkoutButton = document.getElementById('checkout-button');
            if (checkoutButton.disabled) return;
            
            const idleContent = checkoutButton.querySelector('.checkout-button-idle');
            const loadingContent = checkoutButton.querySelector('.checkout-button-loading');
            
            checkoutButton.disabled = true;
            idleContent.classList.add('hidden');
            loadingContent.classList.remove('hidden');

            // O timeout é removido para uma ação mais direta
            try {
                const total = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0) * (1 + state.settings.taxRate / 100);
                document.getElementById('payment-total').textContent = formatCurrency(total);
                document.getElementById('cash-received').value = '';
                document.getElementById('cash-change').textContent = 'R$ 0,00';
                document.getElementById('payment-modal').classList.remove('hidden');
            } catch (error) {
                 console.error("Erro ao abrir modal de pagamento:", error);
                 showToast("Ocorreu um erro. Tente novamente.");
                 // Garante que o botão seja restaurado em caso de erro.
                 checkoutButton.disabled = false;
                 idleContent.classList.remove('hidden');
                 loadingContent.classList.add('hidden');
            }
        }


        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            state.currentPaymentMethod = null;
            
            const checkoutButton = document.getElementById('checkout-button');
            const idleContent = checkoutButton.querySelector('.checkout-button-idle');
            const loadingContent = checkoutButton.querySelector('.checkout-button-loading');

            checkoutButton.disabled = state.cart.length === 0;
            idleContent.classList.remove('hidden');
            loadingContent.classList.add('hidden');

            document.getElementById('cash-payment').classList.remove('border-primary', 'bg-blue-50');
            document.getElementById('qrcode-payment').classList.remove('border-primary', 'bg-blue-50');
            document.getElementById('card-payment').classList.remove('border-primary', 'bg-blue-50');
            document.getElementById('cash-details').style.display = 'none';
            document.getElementById('qrcode-details').style.display = 'none';
            document.getElementById('card-details').style.display = 'none';
            
            document.getElementById('card-name').value = '';
            document.getElementById('card-number').value = '';
            document.getElementById('card-expiry').value = '';
            document.getElementById('card-cvv').value = '';
        }

        function openTab(tabName) {
            const modal = document.getElementById('tab-modal');
            modal.classList.remove('hidden');
            renderTabContent(tabName);
        }

        function renderTabContent(tabName) {
            const content = document.getElementById('tab-content');
            const title = document.getElementById('tab-modal-title');
            const tabButtons = document.getElementById('tab-buttons');
            
            tabButtons.innerHTML = `
                <button onclick="renderTabContent('vendas')" data-tab="vendas" class="tab-btn whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Vendas</button>
                <button onclick="renderTabContent('estoque')" data-tab="estoque" class="tab-btn whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Estoque</button>
            `;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                 btn.classList.remove('border-primary', 'text-primary');
                 btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
            });
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('border-primary', 'text-primary');
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');


            if (tabName === 'vendas') {
                title.textContent = 'Histórico de Vendas';
                const getPaymentMethodName = (method) => {
                    if (method === 'cash') return 'Dinheiro';
                    if (method === 'qrcode') return 'QR Code';
                    if (method === 'card') return 'Cartão';
                    return method;
                };

                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium">Histórico Completo</h3>
                        <button id="analyze-sales-btn" onclick="analyzeSalesAI()" class="btn-primary text-sm px-4 py-2 rounded-lg flex items-center gap-1">
                             <span class="gemini-button-idle">✨ Analisar Vendas</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Itens</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${state.salesHistory.length === 0 ? `<tr><td colspan="4" class="text-center py-10 text-gray-500">Nenhuma venda registrada.</td></tr>` : 
                                state.salesHistory.slice().reverse().map(sale => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(sale.date).toLocaleString('pt-BR')}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sale.items.reduce((sum, i) => sum + i.quantity, 0)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getPaymentMethodName(sale.paymentMethod)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${formatCurrency(sale.total)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                if (state.salesHistory.length === 0) {
                    const analyzeBtn = document.getElementById('analyze-sales-btn');
                    if(analyzeBtn) {
                        analyzeBtn.disabled = true;
                        analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            } else if (tabName === 'estoque') {
                title.textContent = 'Controle de Estoque';
                 content.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque Atual</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${state.products.map(product => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${state.categories.find(c=>c.id === product.categoryId)?.name || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm ${product.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-900'}">${product.stock}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }
        
        function closeTabModal() {
            document.getElementById('tab-modal').classList.add('hidden');
        }

        // --- FUNÇÕES DA API GEMINI ---
        
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiAPI(prompt, retries - 1, delay * 2); 
                    }
                    throw new Error(`API Error: ${response.statusText} (Status: ${response.status})`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error('Não foi possível extrair o conteúdo da resposta da IA.');
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw error;
            }
        }

        async function generateProductNameAI() {
            const keywords = document.getElementById('product-keywords').value;
            const categoryId = document.getElementById('product-category').value;
            const category = state.categories.find(c => c.id == categoryId);
            const categoryName = category ? category.name : 'item';

            if (!keywords) {
                showToast('Por favor, insira algumas palavras-chave para a IA.');
                return;
            }

            const button = document.querySelector('#product-modal button[onclick="generateProductNameAI()"]');
            const idleIcon = button.querySelector('.gemini-button-idle');
            const loadingIcon = button.querySelector('.gemini-button-loading');

            idleIcon.classList.add('hidden');
            loadingIcon.classList.remove('hidden');
            button.disabled = true;

            const prompt = `Você é um especialista em marketing para cardápios. Crie um nome de produto criativo e um preço sugerido para um item na categoria "${categoryName}" com as seguintes características: "${keywords}".
            Responda APENAS no seguinte formato, sem formatação extra ou explicações:
            Nome: [Nome do Produto]
            Preço: [Preço em formato numérico, ex: 12.50]`;

            try {
                const response = await callGeminiAPI(prompt);
                const nameMatch = response.match(/Nome: (.*)/);
                const priceMatch = response.match(/Preço: (.*)/);

                if (nameMatch && nameMatch[1]) {
                    document.getElementById('product-name').value = nameMatch[1].trim();
                }
                if (priceMatch && priceMatch[1]) {
                    document.getElementById('product-price').value = parseFloat(priceMatch[1].trim().replace(',', '.')).toFixed(2);
                }
                showToast('Sugestão de produto gerada!');
            } catch (error) {
                showToast('Erro ao gerar sugestão. Tente novamente.');
            } finally {
                idleIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
                button.disabled = false;
            }
        }

        function openAiAnalysisModal() {
            document.getElementById('ai-analysis-modal').classList.remove('hidden');
        }

        function closeAiAnalysisModal() {
            document.getElementById('ai-analysis-modal').classList.add('hidden');
        }

        async function analyzeSalesAI() {
            const analysisContent = document.getElementById('ai-analysis-content');
            openAiAnalysisModal();
            analysisContent.innerHTML = `<div class="text-center p-8">
                <p class="animate-pulse">Analisando seus dados de vendas... Por favor, aguarde.</p>
            </div>`;

            const simplifiedSales = state.salesHistory.map(sale => ({
                total: sale.total,
                itemsCount: sale.items.reduce((acc, item) => acc + item.quantity, 0),
                date: sale.date,
                items: sale.items.map(i => ({ name: i.name, quantity: i.quantity, price: i.price }))
            }));

            const prompt = `Aja como um analista de negócios para um pequeno café. Analise os seguintes dados de vendas (em formato JSON) e forneça um resumo conciso em português.

            Dados de Vendas:
            ${JSON.stringify(simplifiedSales, null, 2)}

            Seu resumo deve ser formatado em Markdown e incluir:
            - **Visão Geral:** Um parágrafo curto sobre o desempenho geral das vendas (total vendido, número de vendas).
            - **Produtos Populares:** Uma lista (bullet points) dos 2-3 produtos mais vendidos em quantidade.
            - **Sugestão Estratégica:** Uma sugestão criativa e acionável para aumentar as vendas. Por exemplo, sugerir um combo com um item popular e um menos popular, ou uma promoção para um dia específico.

            Seja amigável e encorajador.`;

            try {
                const response = await callGeminiAPI(prompt);
                // Conversão simples de Markdown para HTML
                let htmlResponse = response
                    .replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>') 
                    .replace(/\n\s*-\s(.*?)/g, '<li class="ml-4 list-disc">$1</li>') 
                    .replace(/\n/g, '<br>');

                htmlResponse = htmlResponse.replace(/(<li.*<\/li>)+/g, '<ul>$&</ul>').replace(/<\/li><br>/g, '</li>');

                analysisContent.innerHTML = htmlResponse;
            } catch (error) {
                analysisContent.innerHTML = `<p class="text-red-500">Ocorreu um erro ao analisar os dados. Por favor, tente novamente mais tarde.</p>`;
            }
        }

        // --- FUNÇÕES UTILITÁRIAS ---
        let confirmActionCallback = null;

        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-modal-message').textContent = message;
            confirmActionCallback = onConfirm;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            confirmActionCallback = null;
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        let toastTimeout;
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            clearTimeout(toastTimeout);
            
            toast.classList.remove('toast-exit', 'toast-exit-active');
            toast.classList.add('toast-enter', 'toast-enter-active');
            
            toastTimeout = setTimeout(() => {
                toast.classList.remove('toast-enter', 'toast-enter-active');
                toast.classList.add('toast-exit', 'toast-exit-active');
            }, 3000);
        }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', function() {
            renderAll();
            showToast('Bem-vindo ao Vendas Fácil!');

            // Adiciona eventos aos botões do modal de confirmação
            document.getElementById('confirm-action-btn').addEventListener('click', () => {
                if (confirmActionCallback) {
                    confirmActionCallback();
                }
                hideConfirmationModal();
            });

            document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirmationModal);
        });

    </script>
</body>
</html>

