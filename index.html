<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas Fácil - Ponto de Vendas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- jsPDF e html2canvas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, writeBatch, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Suas configurações do Firebase
        const firebaseConfig = { 
            apiKey : "AIzaSyCJvkGWjDU8BsJiv7FPLOYAtRUA-2389mE", 
            authDomain: "vendasbalcaofacil.firebaseapp.com",
            projectId: "vendasbalcaofacil",
            storageBucket : "vendasbalcaofacil.appspot.com", 
            messagingSenderId : "456005545901", 
            appId : "1:456005545901:web:c4222ebff0f8a54af8fb24", 
            measurementId : "G-1NKJH44XSV" 
        };

        // Inicializa o Firebase e disponibiliza as funções globalmente
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.firebase = { db, auth, collection, onSnapshot, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, signInAnonymously, onAuthStateChanged, writeBatch, getDocs, Timestamp };
    </script>

    <style>
        :root {
            --color-primary: 29, 78, 216; /* blue-700 */
            --color-secondary: 59, 130, 246; /* blue-500 */
            --color-accent: 34, 197, 94; /* green-500 */
            --font-family: 'Inter', sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: #f1f5f9; /* slate-100 */
        }
        .bg-primary { background-color: rgb(var(--color-primary)); }
        .bg-secondary { background-color: rgb(var(--color-secondary)); }
        .bg-accent { background-color: rgb(var(--color-accent)); }
        .text-primary { color: rgb(var(--color-primary)); }
        .text-secondary { color: rgb(var(--color-secondary)); }
        .border-primary { border-color: rgb(var(--color-primary)); }
        .hover\:bg-primary-dark:hover { background-color: rgb(var(--color-primary) / 0.9); }
        .ring-primary:focus { --tw-ring-color: rgb(var(--color-primary)); }
        .btn-primary {
            background-color: rgb(var(--color-primary));
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: rgb(var(--color-primary) / 0.8);
        }
        .btn-secondary {
            background-color: rgb(var(--color-secondary));
            color: white;
            transition: background-color 0.3s;
        }
       .btn-secondary:hover {
            background-color: rgb(var(--color-secondary) / 0.8);
        }
        .btn-accent {
            background-color: rgb(var(--color-accent));
            color: white;
            transition: background-color 0.3s;
        }
        .btn-accent:hover {
            background-color: rgb(var(--color-accent) / 0.8);
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-danger:hover {
             background-color: #b91c1c; /* red-700 */
        }

        /* Animação para notificações (toast) */
        .toast-enter {
            opacity: 0;
            transform: translateX(100%);
        }
        .toast-enter-active {
            opacity: 1;
            transform: translateX(0);
            transition: all 300ms;
        }
        .toast-exit-active {
            opacity: 0;
            transform: translateX(100%);
            transition: all 300ms;
        }

        /* Estilo para a nota fiscal amarela */
        .nota-fiscal {
            font-family: 'Courier New', Courier, monospace;
            background-color: #ffffe0;
            border: 2px dashed #333;
            color: #333;
            padding: 20px;
            width: 302px; /* Largura comum de impressora térmica */
            margin: 0 auto;
        }
        .nota-fiscal * {
            font-size: 12px;
            line-height: 1.4;
        }
        .nota-fiscal .header {
            text-align: center;
            border-bottom: 1px dashed #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .nota-fiscal .item-row {
            display: flex;
            justify-content: space-between;
        }
        .nota-fiscal .totals {
            border-top: 1px dashed #333;
            padding-top: 10px;
            margin-top: 10px;
        }
        .nota-fiscal .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 10px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Animação para o ícone do carrinho */
        @keyframes jiggle {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.2) rotate(-5deg); }
        }
        .jiggle-animation {
            animation: jiggle 0.4s ease-in-out;
        }
        
        #btn-finalizar {
            pointer-events: auto;
            position: relative;
            z-index: 10;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            touch-action: manipulation;
        }
    </style>
</head>
<body class="antialiased">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100] p-4">
        <i data-lucide="loader" class="animate-spin w-16 h-16 text-primary mb-4"></i>
        <p class="text-lg text-gray-700">Carregando dados...</p>
    </div>

    <!-- Container da Aplicação (inicialmente oculto) -->
    <div id="app" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6 p-4 lg:p-6 min-h-screen">

        <!-- Coluna da Esquerda: Produtos e Categorias -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 flex flex-col">
            <header class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div id="logo-container" class="flex items-center gap-3">
                         <span id="header-cart-icon-container" class="bg-primary p-2 rounded-lg text-white">
                            <i data-lucide="shopping-cart"></i>
                        </span>
                        <h1 id="app-title" class="text-2xl font-bold text-gray-800">Vendas Fácil</h1>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openTab('vendas')" class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-blue-100 transition-colors"><i data-lucide="line-chart"></i></button>
                    <button onclick="openTab('estoque')" class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-blue-100 transition-colors"><i data-lucide="boxes"></i></button>
                    <button onclick="openSettingsModal()" class="p-2 text-gray-600 hover:text-primary rounded-full hover:bg-blue-100 transition-colors"><i data-lucide="settings"></i></button>
                </div>
            </header>

            <!-- Filtros de Categoria -->
            <div id="category-filters" class="flex flex-wrap gap-2 mb-4 pb-4 border-b">
                <!-- Categorias serão inseridas aqui -->
            </div>

            <!-- Lista de Produtos -->
            <div id="product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto flex-grow pr-2">
                <!-- Produtos serão inseridos aqui -->
            </div>
        </div>

        <!-- Coluna da Direita: Carrinho e Pagamento -->
        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pedido Atual</h2>
            
            <!-- Itens do Carrinho -->
            <div id="cart-items" class="flex-grow overflow-y-auto -mr-2 pr-2">
                <div id="cart-empty-message" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <i data-lucide="shopping-basket" class="w-16 h-16 mb-2"></i>
                    <span>Seu carrinho está vazio.</span>
                </div>
                <!-- Itens do carrinho serão inseridos aqui -->
            </div>

            <!-- Resumo e Total -->
            <div class="mt-auto pt-4 border-t">
                <div class="space-y-2 text-gray-700">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center">
                         <div class="flex items-center gap-1">
                            <span>Taxa</span>
                            <button onclick="editTax()" class="text-secondary hover:underline text-xs">(editar)</button>
                        </div>
                        <span id="cart-tax">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total</span>
                        <span id="cart-total">R$ 0,00</span>
                    </div>
                </div>
                <button id="btn-finalizar" type="button" class="w-full btn-primary font-bold py-3 rounded-lg mt-4 flex items-center justify-center gap-2" disabled>
                    <span class="checkout-button-idle flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span>Finalizar Compra</span>
                    </span>
                    <span class="checkout-button-loading hidden items-center justify-center gap-2">
                        <i data-lucide="loader" class="animate-spin w-5 h-5"></i>
                        <span>Processando...</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Modal de Gerenciamento (Produtos/Categorias) -->
    <div id="management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 id="management-modal-title" class="text-2xl font-bold text-gray-800">Gerenciamento</h2>
                <button onclick="closeManagementModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Seção de Produtos -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Produtos</h3>
                        <button onclick="openProductModal()" class="btn-secondary text-sm px-4 py-2 rounded-lg flex items-center gap-1"><i data-lucide="plus" class="w-4 h-4"></i>Novo</button>
                    </div>
                    <div id="product-management-list" class="h-80 overflow-y-auto pr-2 space-y-2"></div>
                </div>
                <!-- Seção de Categorias -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Categorias</h3>
                        <button onclick="openCategoryModal()" class="btn-secondary text-sm px-4 py-2 rounded-lg flex items-center gap-1"><i data-lucide="plus" class="w-4 h-4"></i>Nova</button>
                    </div>
                    <div id="category-management-list" class="h-80 overflow-y-auto pr-2 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Tabs (Vendas/Estoque) -->
    <div id="tab-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl h-[90vh] p-8 flex flex-col transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 id="tab-modal-title" class="text-2xl font-bold text-gray-800">Painel</h2>
                <button onclick="closeTabModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div class="border-b border-gray-200">
                <nav id="tab-buttons" class="-mb-px flex space-x-8" aria-label="Tabs">
                    <!-- Tab buttons go here -->
                </nav>
            </div>
            <div id="tab-content" class="flex-grow overflow-y-auto mt-6">
                <!-- Tab content goes here -->
            </div>
        </div>
    </div>
    
    <!-- Modal Adicionar/Editar Produto -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition-all">
            <h2 id="product-modal-title" class="text-xl font-bold mb-4">Adicionar Produto</h2>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id">
                <div class="space-y-4">
                    <div>
                        <label for="product-category" class="block text-sm font-medium text-gray-700">Categoria</label>
                        <select id="product-category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required></select>
                    </div>
                     <div>
                        <label for="product-keywords" class="block text-sm font-medium text-gray-700">Palavras-chave (para IA)</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="product-keywords" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="Ex: doce, morango, refrescante">
                            <button type="button" onclick="generateProductNameAI()" class="p-2 btn-secondary rounded-md" title="Gerar nome e preço com IA">
                                <span class="gemini-button-idle">✨</span>
                                <span class="gemini-button-loading hidden animate-spin">⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                        <input type="text" id="product-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                           <label for="product-price" class="block text-sm font-medium text-gray-700">Preço (R$)</label>
                           <input type="number" id="product-price" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                        </div>
                        <div>
                           <label for="product-stock" class="block text-sm font-medium text-gray-700">Estoque</label>
                           <input type="number" id="product-stock" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                        </div>
                    </div>
                    <div>
                        <label for="product-image" class="block text-sm font-medium text-gray-700">URL da Imagem</label>
                        <input type="text" id="product-image" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="https://exemplo.com/imagem.png">
                    </div>
                    <div>
                        <label for="product-color-picker" class="block text-sm font-medium text-gray-700">Cor do Card</label>
                        <div class="mt-1 flex items-center gap-2">
                            <input type="color" id="product-color-picker" class="p-0 h-10 w-10 border-gray-300 rounded-md cursor-pointer" value="#FFFFFF">
                            <input type="text" id="product-color-hex" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="Ex: #FFFFFF">
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeProductModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Categoria -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition-all">
            <h2 id="category-modal-title" class="text-xl font-bold mb-4">Adicionar Categoria</h2>
            <form id="category-form" onsubmit="saveCategory(event)">
                <input type="hidden" id="category-id">
                <div>
                    <label for="category-name" class="block text-sm font-medium text-gray-700">Nome da Categoria</label>
                    <input type="text" id="category-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" required>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeCategoryModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Configurações -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition-all">
            <h2 class="text-xl font-bold mb-4">Configurações</h2>
            <div class="space-y-6">
                <div>
                    <label for="settings-app-name" class="block text-sm font-medium text-gray-700">Nome da Loja</label>
                    <input type="text" id="settings-app-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="settings-logo-url" class="block text-sm font-medium text-gray-700">URL do Logo</label>
                    <input type="text" id="settings-logo-url" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="https://exemplo.com/logo.png">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cor do Tema</label>
                    <div class="mt-2 flex gap-3">
                        <button onclick="changeTheme('blue')" class="w-8 h-8 rounded-full bg-blue-600 ring-2 ring-offset-2 ring-transparent focus:ring-blue-500"></button>
                        <button onclick="changeTheme('green')" class="w-8 h-8 rounded-full bg-green-600 ring-2 ring-offset-2 ring-transparent focus:ring-green-500"></button>
                        <button onclick="changeTheme('purple')" class="w-8 h-8 rounded-full bg-purple-600 ring-2 ring-offset-2 ring-transparent focus:ring-purple-500"></button>
                        <button onclick="changeTheme('red')" class="w-8 h-8 rounded-full bg-red-600 ring-2 ring-offset-2 ring-transparent focus:ring-red-500"></button>
                    </div>
                </div>
                <div>
                    <button onclick="openManagementModal()" class="w-full text-left px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 flex justify-between items-center">
                        <span>Gerenciar Produtos e Categorias</span>
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
                 <div>
                    <button onclick="openSubscriptionModal()" class="w-full text-left px-4 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 flex justify-between items-center">
                        <span>Gerenciar Assinatura</span>
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" onclick="saveSettings()" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 transform transition-all overflow-y-auto max-h-full">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Pagamento</h2>
                <button onclick="closePaymentModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div class="text-center my-4">
                <p class="text-gray-600">Total a Pagar</p>
                <p id="payment-total" class="text-4xl font-bold text-primary">R$ 0,00</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Pagamento com Dinheiro -->
                <div id="cash-payment" class="border rounded-lg p-4 text-center cursor-pointer hover:border-primary hover:bg-blue-50 transition" onclick="selectPaymentMethod('cash')">
                    <i data-lucide="banknote" class="w-12 h-12 mx-auto text-green-500"></i>
                    <p class="font-semibold mt-2">Dinheiro</p>
                </div>
                <!-- Pagamento com Cartão -->
                <div id="card-payment" class="border rounded-lg p-4 text-center cursor-pointer hover:border-primary hover:bg-blue-50 transition" onclick="selectPaymentMethod('card')">
                    <i data-lucide="credit-card" class="w-12 h-12 mx-auto text-indigo-500"></i>
                    <p class="font-semibold mt-2">Cartão</p>
                </div>
                <!-- Pagamento com QR Code (Pix) -->
                <div id="qrcode-payment" class="border rounded-lg p-4 text-center cursor-pointer hover:border-primary hover:bg-blue-50 transition" onclick="selectPaymentMethod('qrcode')">
                    <i data-lucide="qr-code" class="w-12 h-12 mx-auto text-blue-500"></i>
                    <p class="font-semibold mt-2">QR Code</p>
                </div>
            </div>

            <!-- Detalhes do Pagamento (Dinâmico) -->
            <div id="payment-details-container" class="mt-4">
                <!-- Detalhes Dinheiro -->
                <div id="cash-details" class="space-y-2 hidden">
                     <div>
                        <label for="cash-received" class="block text-sm font-medium text-gray-700">Valor Recebido</label>
                        <input type="number" id="cash-received" oninput="calculateChange()" class="mt-1 text-center w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    </div>
                    <div class="text-lg text-center">
                        <span>Troco: </span>
                        <span id="cash-change" class="font-bold">R$ 0,00</span>
                    </div>
                </div>
                <!-- Detalhes Cartão -->
                <div id="card-details" class="space-y-3 hidden">
                    <div>
                        <label for="card-name" class="block text-sm font-medium text-gray-700">Nome no Cartão</label>
                        <input type="text" id="card-name" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="NOME COMPLETO">
                    </div>
                    <div>
                        <label for="card-number" class="block text-sm font-medium text-gray-700">Número do Cartão</label>
                        <input type="text" id="card-number" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="0000 0000 0000 0000">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="card-expiry" class="block text-sm font-medium text-gray-700">Validade</label>
                            <input type="text" id="card-expiry" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="MM/AA">
                        </div>
                        <div>
                            <label for="card-cvv" class="block text-sm font-medium text-gray-700">CVV</label>
                            <input type="text" id="card-cvv" class="mt-1 text-sm w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary" placeholder="123">
                        </div>
                    </div>
                </div>
                 <!-- Detalhes QR Code -->
                <div id="qrcode-details" class="text-center hidden">
                    <img src="https://placehold.co/150x150/png?text=PIX+QR+Code" alt="[Imagem de um QR Code para pagamento via PIX]" class="mx-auto">
                </div>
            </div>

            <div class="mt-6">
                <button onclick="confirmPayment()" class="w-full btn-accent font-bold py-3 rounded-lg flex items-center justify-center gap-2">
                    <i data-lucide="party-popper"></i>
                    <span>Confirmar Pagamento</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Recibo -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all">
             <div id="receipt-content-wrapper">
                <!-- Conteúdo do recibo será inserido aqui no formato de nota fiscal -->
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
                 <button onclick="printReceipt()" class="w-full px-4 py-2 btn-secondary rounded-lg flex items-center justify-center gap-2"><i data-lucide="printer"></i>Imprimir</button>
                 <button onclick="generatePDF()" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2"><i data-lucide="file-down"></i>Gerar PDF</button>
            </div>
            <div class="mt-4 text-center">
                 <button onclick="closeReceiptModalAndReset()" class="px-4 py-2 btn-primary rounded-lg">Nova Venda</button>
            </div>
        </div>
    </div>

    <!-- Modal de Análise de IA (NOVO) -->
    <div id="ai-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6 transform transition-all flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">✨ Análise de Vendas com IA</h2>
                <button onclick="closeAiAnalysisModal()" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="x"></i></button>
            </div>
            <div id="ai-analysis-content" class="prose max-w-none text-gray-700 overflow-y-auto" style="max-height: 60vh;">
                <!-- Conteúdo da análise será inserido aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[80] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center transform transition-all">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar Ação</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" id="confirmation-modal-message">Tem certeza?</p>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="confirm-cancel-btn" type="button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-action-btn" type="button" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
    
     <!-- Modal de Assinatura -->
    <div id="subscription-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[90] p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8 transform transition-all overflow-y-auto max-h-[90vh]">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Escolha o plano ideal para você</h2>
            <p class="text-center text-gray-600 mb-8">Comece com um teste gratuito de 14 dias nos planos pagos.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Plano Gratuito -->
                <div class="border rounded-lg p-6 flex flex-col">
                    <h3 class="text-xl font-bold text-primary">Gratuito</h3>
                    <p class="text-3xl font-bold my-4">R$ 0<span class="text-sm font-normal text-gray-500">/mês</span></p>
                    <ul class="space-y-2 text-gray-600 mb-6 flex-grow">
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Até 10 produtos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Até 3 categorias</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Histórico de 10 vendas</li>
                        <li class="flex items-center gap-2 text-gray-400"><i data-lucide="x" class="text-red-500"></i>Cores nos cards</li>
                        <li class="flex items-center gap-2 text-gray-400"><i data-lucide="x" class="text-red-500"></i>Funções de IA</li>
                    </ul>
                    <button onclick="selectPlan('gratuito')" class="w-full btn-secondary font-bold py-2 rounded-lg mt-4">Começar Agora</button>
                </div>
                <!-- Plano Básico -->
                <div class="border-2 border-primary rounded-lg p-6 flex flex-col relative">
                    <div class="absolute top-0 -translate-y-1/2 w-full flex justify-center">
                        <span class="bg-primary text-white text-xs font-bold px-3 py-1 rounded-full">MAIS POPULAR</span>
                    </div>
                    <h3 class="text-xl font-bold text-primary">Básico</h3>
                    <p class="text-3xl font-bold my-4">R$ 9.99<span class="text-sm font-normal text-gray-500">/mês</span></p>
                    <ul class="space-y-2 text-gray-600 mb-6 flex-grow">
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Até 50 produtos</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Até 10 categorias</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Histórico de vendas ilimitado</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Cores nos cards</li>
                         <li class="flex items-center gap-2 text-gray-400"><i data-lucide="x" class="text-red-500"></i>Funções de IA</li>
                    </ul>
                    <button onclick="selectPlan('basico')" class="w-full btn-primary font-bold py-2 rounded-lg mt-4">Iniciar Teste Gratuito</button>
                </div>
                <!-- Plano Pro -->
                <div class="border rounded-lg p-6 flex flex-col">
                    <h3 class="text-xl font-bold text-primary">Pro</h3>
                    <p class="text-3xl font-bold my-4">R$ 49.99<span class="text-sm font-normal text-gray-500">/mês</span></p>
                    <ul class="space-y-2 text-gray-600 mb-6 flex-grow">
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Produtos ilimitados</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Categorias ilimitadas</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Histórico de vendas ilimitado</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Cores nos cards</li>
                        <li class="flex items-center gap-2"><i data-lucide="check" class="text-green-500"></i>Funções de IA</li>
                    </ul>
                    <button onclick="selectPlan('pro')" class="w-full btn-primary font-bold py-2 rounded-lg mt-4">Iniciar Teste Gratuito</button>
                </div>
            </div>
             <p id="current-plan-info" class="text-center text-gray-600 mt-6 hidden"></p>
        </div>
    </div>
    
    <!-- Modal de Checkout Stripe (Simulação) -->
    <div id="stripe-checkout-modal" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-[95] p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md transform transition-all">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900">Finalizar Assinatura</h3>
                <p class="mt-1 text-sm text-gray-500">Seu período de teste de 14 dias começará hoje.</p>
                <div class="mt-4 text-center bg-blue-50 p-4 rounded-lg">
                    <p class="font-semibold text-blue-800" id="stripe-plan-name"></p>
                    <p class="text-2xl font-bold text-blue-900" id="stripe-plan-price"></p>
                </div>
                
                <div class="mt-6 space-y-3">
                     <div>
                        <label for="stripe-card-number" class="block text-sm font-medium text-gray-700">Número do Cartão</label>
                        <input type="text" id="stripe-card-number" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="4242 4242 4242 4242">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="stripe-card-expiry" class="block text-sm font-medium text-gray-700">Validade</label>
                            <input type="text" id="stripe-card-expiry" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="MM / AA">
                        </div>
                        <div>
                            <label for="stripe-card-cvc" class="block text-sm font-medium text-gray-700">CVC</label>
                            <input type="text" id="stripe-card-cvc" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="123">
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end gap-3">
                <button onclick="closeStripeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button onclick="confirmSubscription()" class="px-4 py-2 btn-primary rounded-lg">Pagar e Assinar</button>
            </div>
        </div>
    </div>


    <!-- Notificação (Toast) -->
    <div id="toast-notification" class="fixed top-5 right-5 z-[90] w-full max-w-sm transition-all transform toast-enter">
        <div class="text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3">
            <span id="toast-icon-container" class="flex-shrink-0"></span>
            <span id="toast-message" class="flex-grow"></span>
        </div>
    </div>

    <script>
        // --- ESTADO DA APLICAÇÃO ---
        let userState = {
            userId: null,
            subscription: null // { plan, status, trial_end }
        };
        let state = {
            products: [], 
            categories: [],
            cart: [],
            salesHistory: [],
            settings: { 
                appName: 'Vendas Fácil',
                logoUrl: '',
                taxRate: 0, 
                theme: 'blue',
            },
            activeCategoryFilter: 'all',
            currentPaymentMethod: null,
            selectedProductId: null,
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO ---

        function renderAll() {
            renderCategories();
            renderProducts();
            renderCart();
            renderManagementLists();
            applySettings();
            updateCheckoutButton();
            lucide.createIcons();
        }

        function renderProducts() {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            const filteredProducts = state.products.filter(p => 
                state.activeCategoryFilter === 'all' || p.categoryId == state.activeCategoryFilter
            );

            if (filteredProducts.length === 0 && state.categories.length > 0) {
                 productList.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">
                    <i data-lucide="coffee" class="w-12 h-12 mx-auto mb-2"></i>
                    <p>Nenhum produto encontrado nesta categoria.</p>
                </div>`;
                 lucide.createIcons();
                 return;
            }

            filteredProducts.forEach(product => {
                const isOutOfStock = product.stock <= 0;
                const productCard = document.createElement('div');
                const cardColor = product.cardColor || '#FFFFFF';
                const textColorClass = getTextColorForBackground(cardColor);
                const isSelected = product.id === state.selectedProductId;
                
                productCard.className = `border rounded-lg p-3 flex flex-col text-center cursor-pointer transition-shadow hover:shadow-md relative ${isOutOfStock ? 'opacity-50 cursor-not-allowed' : ''} ${textColorClass} ${isSelected ? 'ring-2 ring-offset-2 ring-primary' : ''}`;
                productCard.style.backgroundColor = cardColor;
                productCard.style.borderColor = isSelected ? 'rgb(var(--color-primary))' : (cardColor === '#FFFFFF' ? '#e5e7eb' : cardColor);


                let imageHTML = `<div class="h-24 w-full overflow-hidden rounded-md mb-2">
                                     <img src="${product.image || 'https://placehold.co/150x150/cccccc/969696?text=Sem+Imagem'}" alt="[Imagem de ${product.name}]" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/150x150/cccccc/969696?text=Sem+Imagem';">
                                 </div>`;
                
                const priceColorClass = textColorClass === 'text-white' ? 'text-gray-200' : 'text-primary';

                productCard.innerHTML = `
                    ${isOutOfStock ? '<div class="absolute inset-0 bg-white bg-opacity-50 flex items-center justify-center font-bold text-red-500">ESGOTADO</div>' : ''}
                    ${imageHTML}
                    <h3 class="font-semibold text-sm flex-grow">${product.name}</h3>
                    <p class="font-bold ${priceColorClass} mt-1">${formatCurrency(product.price)}</p>
                `;
                
                productCard.onclick = () => !isOutOfStock && selectAndAddToCart(product.id);
                
                productList.appendChild(productCard);
            });
        }

        function renderCategories() {
            const categoryFilters = document.getElementById('category-filters');
            categoryFilters.innerHTML = `
                <button onclick="filterByCategory('all')" class="category-btn ${state.activeCategoryFilter === 'all' ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'} px-4 py-1 rounded-full text-sm font-medium">Todos</button>
            `;
            state.categories.forEach(category => {
                const categoryBtn = document.createElement('button');
                categoryBtn.textContent = category.name;
                categoryBtn.onclick = () => filterByCategory(category.id);
                categoryBtn.className = `category-btn ${state.activeCategoryFilter == category.id ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'} px-4 py-1 rounded-full text-sm font-medium`;
                categoryFilters.appendChild(categoryBtn);
            });
        }
        
        function renderCart() {
            const cartItems = document.getElementById('cart-items');
            cartItems.innerHTML = '';
            
            if (state.cart.length === 0) {
                cartItems.innerHTML = `
                    <div id="cart-empty-message" class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i data-lucide="shopping-basket" class="w-16 h-16 mb-2"></i>
                        <span>Seu carrinho está vazio.</span>
                    </div>
                `;
                lucide.createIcons();
            } else {
                state.cart.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between py-2';
                    itemDiv.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="updateCartQuantity('${item.productId}', -1)" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateCartQuantity('${item.productId}', 1)" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300">+</button>
                        </div>
                        <span class="font-bold w-20 text-right">${formatCurrency(item.price * item.quantity)}</span>
                    `;
                    cartItems.appendChild(itemDiv);
                });
            }
            calculateTotals();
        }

        function renderManagementLists() {
            const productManagementList = document.getElementById('product-management-list');
            productManagementList.innerHTML = '';
            state.products.forEach(p => {
                productManagementList.innerHTML += `
                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100">
                        <div>
                            <p class="font-medium">${p.name}</p>
                            <p class="text-sm text-gray-500">${formatCurrency(p.price)} - Estoque: ${p.stock}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openProductModal('${p.id}')" class="p-2 text-gray-500 hover:text-blue-600"><i data-lucide="edit"></i></button>
                            <button onclick="deleteProduct('${p.id}')" class="p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2"></i></button>
                        </div>
                    </div>
                `;
            });

            const categoryManagementList = document.getElementById('category-management-list');
            categoryManagementList.innerHTML = '';
            state.categories.forEach(c => {
                 categoryManagementList.innerHTML += `
                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100">
                        <p class="font-medium">${c.name}</p>
                        <div class="flex gap-2">
                            <button onclick="openCategoryModal('${c.id}')" class="p-2 text-gray-500 hover:text-blue-600"><i data-lucide="edit"></i></button>
                            <button onclick="deleteCategory('${c.id}')" class="p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2"></i></button>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // --- FUNÇÕES DE LÓGICA (com Firebase) ---
        
        function selectAndAddToCart(productId) {
            state.selectedProductId = productId;
            renderProducts();

            setTimeout(() => {
                addToCart(productId);
                state.selectedProductId = null;
                renderProducts();
            }, 300);
        }

        function addToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) return;

            const cartItem = state.cart.find(item => item.productId === productId);
            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    showToast('Estoque máximo do produto atingido no carrinho.', 'warning');
                    return;
                }
            } else {
                state.cart.push({ productId: product.id, name: product.name, price: product.price, quantity: 1 });
            }
            renderCart();
            updateCheckoutButton();
            
            showToast(`${product.name} adicionado ao carrinho!`);
            const cartIcon = document.getElementById('header-cart-icon-container');
            if(cartIcon) {
                cartIcon.classList.remove('jiggle-animation');
                void cartIcon.offsetWidth;
                cartIcon.classList.add('jiggle-animation');
            }
        }

        function updateCartQuantity(productId, change) {
            const cartItem = state.cart.find(item => item.productId === productId);
            const product = state.products.find(p => p.id === productId);
            if (!cartItem || !product) return;

            const newQuantity = cartItem.quantity + change;
            if (newQuantity > product.stock) {
                showToast('Quantidade excede o estoque disponível.', 'warning');
                return;
            }

            if (newQuantity <= 0) {
                state.cart = state.cart.filter(item => item.productId !== productId);
            } else {
                cartItem.quantity = newQuantity;
            }
            renderCart();
            updateCheckoutButton();
        }

        function calculateTotals() {
            const subtotal = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const tax = subtotal * (state.settings.taxRate / 100);
            const total = subtotal + tax;
            document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('cart-tax').textContent = formatCurrency(tax);
            document.getElementById('cart-total').textContent = formatCurrency(total);
        }
        
        function updateCheckoutButton() {
            const checkoutButton = document.getElementById('btn-finalizar');
            checkoutButton.disabled = state.cart.length === 0;
            checkoutButton.classList.toggle('opacity-50', checkoutButton.disabled);
            checkoutButton.classList.toggle('cursor-not-allowed', checkoutButton.disabled);
        }

        function filterByCategory(categoryId) {
            state.activeCategoryFilter = categoryId;
            renderProducts();
        }

        async function saveProduct(event) {
            event.preventDefault();
            if(checkPlanLimit('products')) return;

            const id = document.getElementById('product-id').value;
            const color = document.getElementById('product-color-hex').value;
            
            const productData = {
                name: document.getElementById('product-name').value,
                categoryId: document.getElementById('product-category').value,
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                image: document.getElementById('product-image').value,
                cardColor: color || '#FFFFFF'
            };

            try {
                if (id) {
                    await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "products", id), productData);
                    showToast('Produto atualizado com sucesso!');
                } else {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, "users", userState.userId, "products"), productData);
                    showToast('Produto adicionado com sucesso!');
                }
                closeProductModal();
            } catch (e) {
                console.error("Erro ao salvar produto: ", e);
                showToast('Erro ao salvar produto.', 'error');
            }
        }

        function deleteProduct(id) {
            showConfirmationModal('Tem certeza que deseja remover este produto?', async () => {
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "products", id));
                    state.cart = state.cart.filter(item => item.productId !== id);
                    renderCart();
                    showToast('Produto removido com sucesso!');
                } catch (e) {
                    console.error("Erro ao remover produto: ", e);
                    showToast('Erro ao remover produto.', 'error');
                }
            });
        }
        
        async function saveCategory(event) {
            event.preventDefault();
             if(checkPlanLimit('categories')) return;

            const id = document.getElementById('category-id').value;
            const categoryData = { name: document.getElementById('category-name').value };

            try {
                if (id) {
                    await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "categories", id), categoryData);
                    showToast('Categoria atualizada com sucesso!');
                } else {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, "users", userState.userId, "categories"), categoryData);
                    showToast('Categoria adicionada com sucesso!');
                }
                closeCategoryModal();
            } catch (e) {
                console.error("Erro ao salvar categoria: ", e);
                showToast('Erro ao salvar categoria.', 'error');
            }
        }

        function deleteCategory(id) {
            if (state.products.some(p => p.categoryId === id)) {
                showToast('Não é possível remover: existem produtos associados a esta categoria.', 'warning');
                return;
            }
            showConfirmationModal('Tem certeza que deseja remover esta categoria?', async () => {
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "categories", id));
                    showToast('Categoria removida com sucesso!');
                } catch (e) {
                    console.error("Erro ao remover categoria: ", e);
                    showToast('Erro ao remover categoria.', 'error');
                }
            });
        }
        
        function deleteSale(saleId) {
            showConfirmationModal('Remover este registro de venda? A ação não restaura o estoque.', async () => {
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "salesHistory", saleId));
                    showToast('Registro de venda removido!');
                } catch (e) {
                    console.error("Erro ao remover venda: ", e);
                    showToast('Erro ao remover o registro.', 'error');
                }
            });
        }
        
        async function deleteAllSales() {
            showConfirmationModal('Zerar TODO o histórico de vendas? Esta ação é irreversível.', async () => {
                const { db, collection, getDocs, writeBatch } = window.firebase;
                const salesCollection = collection(db, "users", userState.userId, "salesHistory");
                try {
                    const snapshot = await getDocs(salesCollection);
                    if (snapshot.empty) {
                        showToast("O histórico de vendas já está vazio.", 'warning');
                        return;
                    }
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    showToast('Histórico de vendas zerado com sucesso!');
                } catch (e) {
                    console.error("Erro ao zerar o histórico de vendas: ", e);
                    showToast('Ocorreu um erro ao limpar o histórico.', 'error');
                }
            });
        }

        function applySettings() {
            const themes = {
                blue: { primary: '29, 78, 216', secondary: '59, 130, 246' },
                green: { primary: '21, 128, 61', secondary: '34, 197, 94' },
                purple: { primary: '126, 34, 206', secondary: '168, 85, 247' },
                red: { primary: '220, 38, 38', secondary: '248, 113, 113' },
            };
            const currentTheme = themes[state.settings.theme] || themes.blue;
            document.documentElement.style.setProperty('--color-primary', currentTheme.primary);
            document.documentElement.style.setProperty('--color-secondary', currentTheme.secondary);

            document.getElementById('app-title').textContent = state.settings.appName;
            const logoContainer = document.getElementById('logo-container');
            if (state.settings.logoUrl) {
                logoContainer.innerHTML = `<img src="${state.settings.logoUrl}" alt="Logo" class="h-10"> <h1 id="app-title" class="text-2xl font-bold text-gray-800">${state.settings.appName}</h1>`;
            } else {
                logoContainer.innerHTML = `<span id="header-cart-icon-container" class="bg-primary p-2 rounded-lg text-white"><i data-lucide="shopping-cart"></i></span><h1 id="app-title" class="text-2xl font-bold text-gray-800">${state.settings.appName}</h1>`;
                lucide.createIcons();
            }
        }

        async function saveSettings() {
            const newSettings = {
                appName: document.getElementById('settings-app-name').value,
                logoUrl: document.getElementById('settings-logo-url').value,
                theme: state.settings.theme,
                taxRate: state.settings.taxRate,
            };
            try {
                await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "settings", "appConfig"), newSettings);
                showToast('Configurações salvas!');
                closeSettingsModal();
            } catch (e) {
                console.error("Erro ao salvar configurações:", e);
                showToast("Erro ao salvar configurações.", 'error');
            }
        }

        async function changeTheme(theme) {
            if (checkPlanLimit('colors')) return;
            state.settings.theme = theme;
            applySettings(); 
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "settings", "appConfig"), { theme });
            } catch (e) {
                await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "settings", "appConfig"), state.settings, { merge: true });
            }
        }

        async function editTax() {
            const newTaxRateStr = prompt('Digite a nova taxa em porcentagem (%):', state.settings.taxRate);
            if (newTaxRateStr !== null && !isNaN(newTaxRateStr)) {
                const newTaxRate = parseFloat(newTaxRateStr);
                try {
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "settings", "appConfig"), { taxRate: newTaxRate });
                    showToast('Taxa atualizada!');
                } catch (e) {
                     await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", userState.userId, "settings", "appConfig"), { ...state.settings, taxRate: newTaxRate }, { merge: true });
                     showToast('Taxa atualizada!');
                }
            }
        }

        async function confirmPayment() {
            if (!state.currentPaymentMethod) {
                showToast('Por favor, selecione um método de pagamento.', 'warning');
                return;
            }

            if(checkPlanLimit('sales')) return;
            
            const batch = window.firebase.writeBatch(window.firebase.db);
            const subtotal = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const tax = subtotal * (state.settings.taxRate / 100);
            const total = subtotal + tax;

            const sale = {
                items: JSON.parse(JSON.stringify(state.cart)),
                subtotal, tax, total,
                paymentMethod: state.currentPaymentMethod,
                date: new Date().toISOString(),
            };
            
            if (sale.paymentMethod === 'cash') {
                const amountReceived = parseFloat(document.getElementById('cash-received').value) || 0;
                if (amountReceived < total) {
                    showToast('O valor recebido é menor que o total.', 'warning');
                    return;
                }
                sale.amountReceived = amountReceived;
                sale.changeGiven = amountReceived - total;
            } else if (sale.paymentMethod === 'card') {
                const [cardName, cardNumber, cardExpiry, cardCvv] = ['card-name', 'card-number', 'card-expiry', 'card-cvv'].map(id => document.getElementById(id).value);
                if (!cardName || !cardNumber || !cardExpiry || !cardCvv) {
                    showToast('Por favor, preencha todos os dados do cartão.', 'warning'); return;
                }
                sale.cardLast4 = cardNumber.slice(-4);
            }

            for (const cartItem of state.cart) {
                const productRef = window.firebase.doc(window.firebase.db, "users", userState.userId, "products", cartItem.productId);
                const productDoc = await window.firebase.getDoc(productRef);
                if (productDoc.exists() && productDoc.data().stock >= cartItem.quantity) {
                    batch.update(productRef, { stock: productDoc.data().stock - cartItem.quantity });
                } else {
                    showToast(`Estoque insuficiente para ${cartItem.name}. Venda cancelada.`, 'error'); return;
                }
            }
            
            batch.set(window.firebase.doc(window.firebase.collection(window.firebase.db, "users", userState.userId, "salesHistory")), sale);

            try {
                await batch.commit();
                closePaymentModal();
                showReceipt(sale);
                showToast('Venda finalizada com sucesso!');
            } catch (e) {
                console.error("Erro ao finalizar venda: ", e);
                showToast('Erro ao finalizar a venda. Estoque não foi alterado.', 'error');
            }
        }
        
        function showReceipt(sale) {
            const receiptContent = document.getElementById('receipt-content-wrapper');
            let itemsHtml = sale.items.map(item => `
                <div class="item-row">
                    <span>${item.quantity}x ${item.name}</span>
                    <span>${formatCurrency(item.price * item.quantity)}</span>
                </div>`).join('');

            let paymentDetailsHtml = '';
            if (sale.paymentMethod === 'cash') {
                paymentDetailsHtml = `
                    <div class="item-row"><span>Valor Recebido:</span> <span>${formatCurrency(sale.amountReceived)}</span></div>
                    <div class="item-row"><span>Troco:</span> <span>${formatCurrency(sale.changeGiven)}</span></div>`;
            } else if (sale.paymentMethod === 'card') {
                 paymentDetailsHtml = `<div class="item-row"><span>Cartão Final:</span> <span>**** ${sale.cardLast4}</span></div>`;
            }

            receiptContent.innerHTML = `<div class="nota-fiscal" id="receipt-to-print">
                <div class="header">
                    <h3 class="font-bold text-lg">${state.settings.appName}</h3>
                    <p>COMPROVANTE DE VENDA</p>
                    <p>${new Date(sale.date).toLocaleString('pt-BR')}</p>
                </div>
                <div class="items">${itemsHtml}</div>
                <div class="totals">
                    <div class="item-row"><span>Subtotal:</span> <span>${formatCurrency(sale.subtotal)}</span></div>
                    <div class="item-row"><span>Taxa:</span> <span>${formatCurrency(sale.tax)}</span></div>
                    <div class="item-row font-bold"><span>Total:</span> <span>${formatCurrency(sale.total)}</span></div>
                    ${paymentDetailsHtml}
                </div>
                <div class="footer">Obrigado pela preferência!</div>
            </div>`;
            document.getElementById('receipt-modal').classList.remove('hidden');
        }

        function printReceipt() {
            const printContent = document.getElementById('receipt-to-print').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`<html><head><title>Recibo</title><style>
                body { font-family: 'Courier New', Courier, monospace; font-size: 12px; }
                .item-row { display: flex; justify-content: space-between; } .header, .footer { text-align: center; }
                .totals { border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px; }
            </style></head><body>${printContent}</body></html>`);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const receiptElement = document.getElementById('receipt-to-print');
            const canvas = await html2canvas(receiptElement, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`recibo-${Date.now()}.pdf`);
        }

        function closeReceiptModalAndReset() {
            document.getElementById('receipt-modal').classList.add('hidden');
            state.cart = [];
            state.currentPaymentMethod = null;
            renderAll();
        }

        function openProductModal(id = null) {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            
            const categorySelect = document.getElementById('product-category');
            categorySelect.innerHTML = state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            const colorPicker = document.getElementById('product-color-picker');
            const colorHex = document.getElementById('product-color-hex');

            if (id) {
                document.getElementById('product-modal-title').textContent = 'Editar Produto';
                const product = state.products.find(p => p.id === id);
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-category').value = product.categoryId;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-image').value = product.image;
                colorPicker.value = product.cardColor || '#FFFFFF';
                colorHex.value = product.cardColor || '#FFFFFF';
            } else {
                document.getElementById('product-modal-title').textContent = 'Adicionar Produto';
                colorPicker.value = '#FFFFFF';
                colorHex.value = '#FFFFFF';
            }
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        function openCategoryModal(id = null) {
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';

            if (id) {
                document.getElementById('category-modal-title').textContent = 'Editar Categoria';
                const category = state.categories.find(c => c.id === id);
                document.getElementById('category-id').value = category.id;
                document.getElementById('category-name').value = category.name;
            } else {
                document.getElementById('category-modal-title').textContent = 'Adicionar Categoria';
            }
            document.getElementById('category-modal').classList.remove('hidden');
        }
        
        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
        }
        
        function openSettingsModal() {
            document.getElementById('settings-app-name').value = state.settings.appName;
            document.getElementById('settings-logo-url').value = state.settings.logoUrl;
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function openManagementModal() {
            closeSettingsModal();
            document.getElementById('management-modal').classList.remove('hidden');
            renderManagementLists();
        }

        function closeManagementModal() {
            document.getElementById('management-modal').classList.add('hidden');
        }
        
        function setCheckoutButtonLoading(isLoading) {
            const button = document.getElementById('btn-finalizar');
            const idleContent = button.querySelector('.checkout-button-idle');
            const loadingContent = button.querySelector('.checkout-button-loading');

            if (isLoading) {
                button.disabled = true;
                idleContent.classList.add('hidden');
                loadingContent.classList.remove('hidden');
            } else {
                updateCheckoutButton(); 
                idleContent.classList.remove('hidden');
                loadingContent.classList.add('hidden');
            }
        }
        
        window.abrirPagamento = function() {
            setCheckoutButtonLoading(true);
            try {
                const total = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0) * (1 + state.settings.taxRate / 100);
                document.getElementById('payment-total').textContent = formatCurrency(total);
                document.getElementById('cash-received').value = '';
                document.getElementById('cash-change').textContent = 'R$ 0,00';
                document.getElementById('payment-modal').classList.remove('hidden');
            } catch (error) {
                console.error("Erro ao abrir modal de pagamento:", error);
                showToast("Ocorreu um erro. Tente novamente.", 'error');
                closePaymentModal();
            }
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            state.currentPaymentMethod = null;
            ['cash', 'qrcode', 'card'].forEach(method => {
                document.getElementById(`${method}-payment`).classList.remove('border-primary', 'bg-blue-50');
                document.getElementById(`${method}-details`).style.display = 'none';
            });
            ['card-name', 'card-number', 'card-expiry', 'card-cvv'].forEach(id => document.getElementById(id).value = '');
            setCheckoutButtonLoading(false);
        }

        function openTab(tabName) {
            document.getElementById('tab-modal').classList.remove('hidden');
            renderTabContent(tabName);
        }

        function renderTabContent(tabName) {
            const content = document.getElementById('tab-content');
            const title = document.getElementById('tab-modal-title');
            const tabButtons = document.getElementById('tab-buttons');
            
            tabButtons.innerHTML = `
                <button onclick="renderTabContent('vendas')" data-tab="vendas" class="tab-btn whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Vendas</button>
                <button onclick="renderTabContent('estoque')" data-tab="estoque" class="tab-btn whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Estoque</button>`;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.className = 'tab-btn whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700');
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).className = 'tab-btn whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium border-primary text-primary';


            if (tabName === 'vendas') {
                title.textContent = 'Histórico de Vendas';
                const getPaymentMethodName = (method) => ({ cash: 'Dinheiro', qrcode: 'QR Code', card: 'Cartão' }[method] || method);
                
                const salesToDisplay = userState.subscription?.plan === 'gratuito' 
                    ? [...state.salesHistory].reverse().slice(0, 10) 
                    : [...state.salesHistory].reverse();
                
                content.innerHTML = `<div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-medium">Histórico Completo</h3>
                            <button id="analyze-sales-btn" onclick="analyzeSalesAI()" class="btn-primary text-sm px-4 py-2 rounded-lg flex items-center gap-1">
                                <span class="gemini-button-idle">✨ Analisar Vendas</span>
                            </button>
                        </div>
                        <button id="clear-sales-btn" onclick="deleteAllSales()" class="btn-danger text-sm px-4 py-2 rounded-lg flex items-center gap-1">
                             <i data-lucide="trash-2" class="w-4 h-4"></i> Zerar Histórico
                        </button>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Itens</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pagamento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ações</th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        ${salesToDisplay.length === 0 ? `<tr><td colspan="5" class="text-center py-10 text-gray-500">Nenhuma venda registrada.</td></tr>` : 
                        salesToDisplay.map(sale => `<tr>
                            <td class="px-6 py-4 text-sm text-gray-500">${new Date(sale.date).toLocaleString('pt-BR')}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">${sale.items.reduce((s, i) => s + i.quantity, 0)}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${getPaymentMethodName(sale.paymentMethod)}</td>
                            <td class="px-6 py-4 text-sm font-bold text-gray-900">${formatCurrency(sale.total)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="deleteSale('${sale.id}')" class="p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2"></i></button>
                            </td>
                        </tr>`).join('')}
                        </tbody></table></div>`;
                lucide.createIcons();
                const analyzeBtn = document.getElementById('analyze-sales-btn');
                const clearBtn = document.getElementById('clear-sales-btn');
                if (state.salesHistory.length === 0) {
                    if(analyzeBtn) {
                        analyzeBtn.disabled = true;
                        analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    if(clearBtn) {
                        clearBtn.disabled = true;
                        clearBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            } else if (tabName === 'estoque') {
                title.textContent = 'Controle de Estoque';
                 content.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque</th>
                    </tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    ${state.products.map(p => `<tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${p.name}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${state.categories.find(c=>c.id === p.categoryId)?.name || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm ${p.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-900'}">${p.stock}</td>
                    </tr>`).join('')}
                    </tbody></table></div>`;
            }
        }
        
        function closeTabModal() { document.getElementById('tab-modal').classList.add('hidden'); }
        
        function selectPaymentMethod(method) {
            state.currentPaymentMethod = method;
            ['cash', 'qrcode', 'card'].forEach(m => {
                document.getElementById(`${m}-payment`).classList.toggle('border-primary', m === method);
                document.getElementById(`${m}-payment`).classList.toggle('bg-blue-50', m === method);
                document.getElementById(`${m}-details`).style.display = m === method ? 'block' : 'none';
            });
            if (method === 'cash') document.getElementById('cash-received').focus();
        }
        
        function calculateChange() {
            const total = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0) * (1 + state.settings.taxRate / 100);
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = received - total;
            document.getElementById('cash-change').textContent = formatCurrency(Math.max(0, change));
        }

        // --- LÓGICA DE ASSINATURA ---
        const planLimits = {
            gratuito: { products: 10, categories: 3, sales: 10, colors: false, ai: false },
            basico: { products: 50, categories: 10, sales: Infinity, colors: true, ai: false },
            pro: { products: Infinity, categories: Infinity, sales: Infinity, colors: true, ai: true }
        };

        function checkPlanLimit(feature) {
            const plan = userState.subscription?.plan || 'gratuito';
            const limit = planLimits[plan][feature];

            let currentCount;
            switch(feature) {
                case 'products': currentCount = state.products.length; break;
                case 'categories': currentCount = state.categories.length; break;
                case 'sales': currentCount = state.salesHistory.length; break;
                case 'colors':
                case 'ai':
                    if (!limit) {
                        showToast('Funcionalidade disponível apenas em planos superiores.', 'warning');
                        openSubscriptionModal();
                        return true;
                    }
                    return false;
            }

            if (currentCount >= limit) {
                showToast(`Limite do plano atingido para "${feature}". Faça upgrade para adicionar mais.`, 'warning');
                openSubscriptionModal();
                return true;
            }
            return false;
        }
        
        function openSubscriptionModal() {
            const modal = document.getElementById('subscription-modal');
            modal.classList.remove('hidden');
            const info = document.getElementById('current-plan-info');
            if (userState.subscription) {
                info.textContent = `Seu plano atual é ${userState.subscription.plan}.`;
                info.classList.remove('hidden');
            } else {
                info.classList.add('hidden');
            }
        }
        
        let selectedPlan = null;
        async function selectPlan(planId) {
            if (planId === 'gratuito') {
                const sub = { plan: 'gratuito', status: 'active' };
                await updateUserSubscription(sub);
                document.getElementById('subscription-modal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            } else {
                selectedPlan = planId;
                document.getElementById('stripe-plan-name').textContent = `Plano ${planId.charAt(0).toUpperCase() + planId.slice(1)}`;
                document.getElementById('stripe-plan-price').textContent = planId === 'basico' ? 'R$ 9.99/mês' : 'R$ 49.99/mês';
                document.getElementById('stripe-checkout-modal').classList.remove('hidden');
            }
        }

        function closeStripeModal() {
            document.getElementById('stripe-checkout-modal').classList.add('hidden');
            selectedPlan = null;
        }

        async function confirmSubscription() {
            const { Timestamp } = window.firebase;
            const trialEndDate = new Date();
            trialEndDate.setDate(trialEndDate.getDate() + 14);

            const sub = {
                plan: selectedPlan,
                status: 'trialing',
                trial_end: Timestamp.fromDate(trialEndDate),
            };

            await updateUserSubscription(sub);
            closeStripeModal();
            document.getElementById('subscription-modal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            showToast(`Teste gratuito do plano ${sub.plan} iniciado!`, 'success');
        }
        
        async function updateUserSubscription(subscriptionData) {
            userState.subscription = subscriptionData;
            await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", userState.userId), { subscription: subscriptionData });
        }

        // --- FUNÇÕES DA API GEMINI ---
        async function callGeminiAPI(prompt) { /* ... implementation ... */ }
        async function generateProductNameAI() {
            if(checkPlanLimit('ai')) return;
             /* ... implementation ... */
        }
        function openAiAnalysisModal() { /* ... implementation ... */ }
        function closeAiAnalysisModal() { /* ... implementation ... */ }
        async function analyzeSalesAI() {
            if(checkPlanLimit('ai')) return;
            // ... original implementation ...
        }

        // --- FUNÇÕES UTILITÁRIAS ---
        let confirmActionCallback = null;
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-modal-message').textContent = message;
            confirmActionCallback = onConfirm;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            confirmActionCallback = null;
        }
        
        function formatCurrency(value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); }
        
        function getTextColorForBackground(hexColor) {
            if (!hexColor || hexColor.length < 7) return 'text-gray-800';
            try {
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance > 0.6 ? 'text-gray-800' : 'text-white';
            } catch (e) {
                return 'text-gray-800';
            }
        }
        
        let toastTimeout;
        function showToast(message, type = 'success') { // 'success', 'warning', 'error'
            const toast = document.getElementById('toast-notification');
            const toastContent = toast.querySelector('div');
            const toastIconContainer = document.getElementById('toast-icon-container');
            const toastMessage = document.getElementById('toast-message');
            
            clearTimeout(toastTimeout);
        
            toastContent.classList.remove('bg-accent', 'bg-yellow-500', 'bg-red-600');
        
            const icons = { success: 'check-circle', error: 'alert-circle', warning: 'alert-triangle' };
            const colors = { success: 'bg-accent', error: 'bg-red-600', warning: 'bg-yellow-500' };

            const iconName = icons[type] || 'info';
            toastIconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5"></i>`;
            lucide.createIcons({ nodes: [toastIconContainer.querySelector('i')] });
            
            toastContent.classList.add(colors[type] || 'bg-gray-800');
            toastMessage.textContent = message;
            
            toast.classList.remove('toast-enter', 'toast-exit-active');
            toast.classList.add('toast-enter-active');
            
            toastTimeout = setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
                 setTimeout(() => {
                    toast.classList.add('toast-enter');
                    toast.classList.remove('toast-exit-active');
                }, 300);
            }, 3000);
        }

        // --- INICIALIZAÇÃO COM FIREBASE ---
        function initializeFirebaseApp() {
            const { auth, onAuthStateChanged, signInAnonymously } = window.firebase;
            onAuthStateChanged(auth, user => {
                if (user) {
                    userState.userId = user.uid;
                    setupSnapshots(user.uid);
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Falha ao autenticar:", error);
                        const loadingOverlay = document.getElementById('loading-overlay');
                        if (error.code === 'auth/configuration-not-found') {
                            loadingOverlay.innerHTML = `
                                <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mb-4"></i>
                                <p class="text-lg text-red-700 font-bold">Erro de Configuração do Firebase</p>
                                <p class="text-gray-600 mt-2 text-center max-w-md">
                                    Parece que o <strong>Login Anônimo</strong> não está ativado.<br><br>
                                    1. Vá para o seu projeto no <strong>Firebase Console</strong>.<br>
                                    2. No menu, clique em <strong>Authentication</strong>.<br>
                                    3. Vá para a aba <strong>Sign-in method</strong> e ative o provedor <strong>Anônimo</strong>.
                                </p>
                            `;
                            lucide.createIcons();
                        } else {
                            loadingOverlay.innerHTML = `<p class="text-red-500">Falha ao conectar. Verifique sua conexão e a configuração do Firebase.</p>`;
                        }
                    });
                }
            });
        }

        function setupSnapshots(userId) {
            const { db, collection, onSnapshot, doc } = window.firebase;
            
            const userDocRef = doc(db, "users", userId);
            onSnapshot(userDocRef, async (docSnap) => {
                 if (docSnap.exists() && docSnap.data().subscription) {
                    userState.subscription = docSnap.data().subscription;
                    document.getElementById('app').classList.remove('hidden');
                } else {
                    openSubscriptionModal();
                }
                document.getElementById('loading-overlay').classList.add('hidden');
            });

            onSnapshot(collection(db, "users", userId, "products"), (snapshot) => {
                state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(); renderManagementLists();
            });

            onSnapshot(collection(db, "users", userId, "categories"), (snapshot) => {
                state.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories(); renderManagementLists();
            });

            onSnapshot(collection(db, "users", userId, "salesHistory"), (snapshot) => {
                state.salesHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(!document.getElementById('tab-modal').classList.contains('hidden')) {
                    const activeTab = document.querySelector('.tab-btn.border-primary');
                    if(activeTab) renderTabContent(activeTab.dataset.tab);
                }
            });

            onSnapshot(doc(db, "users", userId, "settings", "appConfig"), (docSnap) => {
                if (docSnap.exists()) {
                    state.settings = { ...state.settings, ...docSnap.data() };
                } else {
                    window.firebase.setDoc(doc(db, "users", userId, "settings", "appConfig"), state.settings);
                }
                applySettings(); 
                calculateTotals();
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeFirebaseApp();

            document.getElementById('confirm-action-btn').addEventListener('click', () => {
                if (confirmActionCallback) confirmActionCallback();
                hideConfirmationModal();
            });
            document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirmationModal);

            // --- INICIALIZAÇÃO DO BOTÃO FINALIZAR COMPRA ---
            (() => {
              const btn = document.getElementById('btn-finalizar');
              if (!btn) return;
            
              let locked = false;
              const onTap = (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (btn.disabled) {
                    showToast('Seu carrinho está vazio. Adicione produtos para continuar.', 'warning');
                    return;
                }

                if (locked) return;
                locked = true; 
                setTimeout(() => locked = false, 600);
            
                if (typeof window.abrirPagamento === 'function') {
                  window.abrirPagamento();
                }
              };
            
              ['pointerup', 'touchend', 'click'].forEach(evt => {
                btn.addEventListener(evt, onTap, { passive: false });
              });
            })();
            
            // --- SINCRONIZAR COLOR PICKER COM INPUT TEXT ---
            const colorPicker = document.getElementById('product-color-picker');
            const colorHex = document.getElementById('product-color-hex');
            
            colorPicker.addEventListener('input', (e) => {
                colorHex.value = e.target.value.toUpperCase();
            });
            colorHex.addEventListener('input', (e) => {
                let val = e.target.value;
                if (val.startsWith('#') && (val.length === 4 || val.length === 7)) {
                    colorPicker.value = val;
                }
            });
        });

    </script>
</body>
</html>

